if(document.getElementById('krt-sys'))document.getElementById('krt-sys').remove();var cleanK=function(u){try{var p=u.split('?')[0].split('#')[0];p=p.replace(/[-_]\d+x\d+(?=\.[a-zA-Z0-9]+$)/i,'');return p;}catch(e){return u;}};var getSc=function(u){try{var p=u.split('?')[0];var m1=p.match(/[-_](\d+)x(\d+)(?=\.[a-zA-Z0-9]+$)/i);if(m1)return parseInt(m1[1])*parseInt(m1[2]);return 0;}catch(e){return 0;}};var uMap=new Map();function a(s){if(!s||typeof s!=='string'||s.startsWith('data:'))return;if(s.startsWith('//'))s='https:'+s;else if(s.startsWith('/'))s=location.origin+s;try{s=decodeURIComponent(s);var d=new URL(s,'http://d');var inr=d.searchParams.get('url');if(inr)s=inr;}catch(e){}var uL=s.toLowerCase().split('?')[0].split('#')[0];if(uL.endsWith('.js')||uL.endsWith('.css')||uL.endsWith('.html')||uL.endsWith('.php')||uL.endsWith('.json')||uL.endsWith('.xml')||uL.endsWith('.txt'))return;if(!uL.match(/\.(jpg|jpeg|png|webp|gif|svg|tiff|heic|ico)$/i))return;var k=cleanK(s);var ex=uMap.get(k);if(!ex){uMap.set(k,s);}else{if(getSc(s)>getSc(ex))uMap.set(k,s);else if(getSc(s)===getSc(ex)&&!s.includes('?')&&ex.includes('?'))uMap.set(k,s);}}Array.from(document.images).forEach(e=>{a(e.src);});Array.from(document.querySelectorAll('img, a, link, source, div, span, bg')).forEach(e=>{var tag=e.tagName.toLowerCase();var ds=e.getAttribute('data-src')||e.getAttribute('data-original')||e.getAttribute('data-lazy-src')||e.getAttribute('data-srcset');if(ds){if(ds.includes(','))ds.split(',').forEach(p=>a(p.trim().split(' ')[0]));else a(ds);}if(tag==='a'||tag==='link'){var h=e.getAttribute('href');if(h)a(h);}var b=window.getComputedStyle(e).backgroundImage;var m=b.match(/url\(['"]?(.*?)['"]?\)/);if(m)a(m[1]);});if(uMap.size===0){var btn=document.createElement('div');btn.style.cssText='position:fixed;top:20px;right:20px;background:#f03;color:#fff;padding:10px 20px;z-index:999999;border-radius:5px;font-family:sans-serif;box-shadow:0 0 10px #000;';btn.innerText='ไม่พบรูปภาพ (KIRITO SYSTEM)';document.body.appendChild(btn);setTimeout(()=>btn.remove(),3000);return;}var sys=document.createElement('div');sys.id='krt-sys';sys.style.cssText='position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(5,0,0,0.95);z-index:9999999;overflow-y:auto;font-family:sans-serif;padding:20px;box-sizing:border-box;color:#fff;';var h='<div style="max-width:1200px;margin:0 auto;"><div style="display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #f03;padding-bottom:10px;margin-bottom:20px;flex-wrap:wrap;gap:10px;"><h1 style="color:#f03;margin:0;text-shadow:0 0 10px #f03;font-size:24px;">KIRITO PULL SYSTEM</h1><div style="display:flex;gap:10px;"><button id="krt-dl-all" style="background:#28a745;color:#fff;border:none;padding:10px 20px;cursor:pointer;border-radius:5px;font-weight:bold;">DOWNLOAD ALL (ZIP)</button><button id="krt-close" style="background:#f03;color:#fff;border:none;padding:10px 20px;cursor:pointer;border-radius:5px;font-weight:bold;">CLOSE (ปิด)</button></div></div><h3>พบรูปภาพทั้งหมด '+uMap.size+' รูป</h3><div id="krt-prog-bg" style="display:none;width:100%;background:#222;border-radius:5px;margin-bottom:15px;overflow:hidden;border:1px solid #444;box-shadow:inset 0 0 10px #000;"><div id="krt-prog" style="width:0%;height:24px;background:#f03;color:#fff;text-align:center;font-size:12px;line-height:24px;font-weight:bold;transition:width 0.3s;">0%</div></div><div id="krt-gal" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px;"></div></div><div id="krt-lb" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.95);z-index:10000000;justify-content:center;align-items:center;overflow:hidden;touch-action:none;"><div id="krt-lbc" style="position:absolute;top:20px;right:20px;color:#fff;font-size:2rem;cursor:pointer;z-index:10000001;background:rgba(0,0,0,0.5);width:40px;height:40px;text-align:center;line-height:40px;border-radius:50%;">&times;</div><img id="krt-lbi" style="max-width:90%;max-height:90%;transition:transform 0.1s ease-out;cursor:grab;user-select:none;-webkit-user-drag:none;"><div style="position:absolute;bottom:20px;background:rgba(0,0,0,0.5);padding:10px 20px;border-radius:20px;display:flex;gap:15px;color:#fff;font-size:0.8rem;"><span>กลิ้งเมาส์: ซูม</span><span>ลาก: เลื่อน</span></div></div>';sys.innerHTML=h;document.body.appendChild(sys);var gal=document.getElementById('krt-gal');var all=Array.from(uMap.values());async function fetchImg(url){const pxs=['','https://api.codetabs.com/v1/proxy?quest=','https://corsproxy.io/?'];for(let px of pxs){try{let tgt=px?px+encodeURIComponent(url):url;let ctrl=new AbortController();let tid=setTimeout(()=>ctrl.abort(),6000);let r=await fetch(tgt,{signal:ctrl.signal});clearTimeout(tid);if(r.ok){let b=await r.blob();if(b.size>150&&!b.type.includes('text/html'))return b;}}catch(e){}}return null;}all.forEach(function(s,idx){var c=document.createElement('div');c.style.cssText='background:#111;border:1px solid #333;border-radius:5px;padding:10px;text-align:center;display:flex;flex-direction:column;justify-content:space-between;';var i=document.createElement('img');i.src=s;i.style.cssText='width:100%;height:120px;object-fit:contain;margin-bottom:10px;background:#000;cursor:zoom-in;';i.setAttribute('data-orig',s);i.setAttribute('data-rts','0');i.onerror=function(){var orig=this.getAttribute('data-orig');var rts=parseInt(this.getAttribute('data-rts'));var pxs=['https://api.codetabs.com/v1/proxy?quest=','https://corsproxy.io/?'];if(rts<pxs.length){this.setAttribute('data-rts',rts+1);this.src=pxs[rts]+encodeURIComponent(orig);}else{this.src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ff3333"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>';this.style.opacity='0.5';this.style.padding='30px';this.title='โหลดภาพล้มเหลว (บล็อกโดยเว็บต้นทาง)';this.style.cursor='default';}};i.onload=function(){if(this.src.startsWith('data:image/svg'))return;if(this.naturalWidth<30)this.onerror();};var info=document.createElement('div');info.style.cssText='color:#aaa;font-size:10px;margin-bottom:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;';var fname=s.split('/').pop().split('?')[0];try{fname=decodeURIComponent(fname);}catch(e){}info.innerText=fname||'image';var d=document.createElement('button');d.innerText='ดาวน์โหลด';d.style.cssText='display:block;width:100%;background:#f03;color:#fff;border:none;padding:8px;border-radius:3px;font-size:12px;font-weight:bold;margin-top:auto;cursor:pointer;';d.onclick=async function(e){e.preventDefault();var ogD=d.innerText;d.innerText='กำลังโหลด...';d.style.pointerEvents='none';let b=await fetchImg(s);if(b){var u2=URL.createObjectURL(b);var a2=document.createElement('a');a2.href=u2;a2.download='KIRITO_'+Date.now()+'.jpg';a2.click();URL.revokeObjectURL(u2);d.innerText='สำเร็จ!';d.style.background='#28a745';}else{window.open(s,'_blank');d.innerText='ล้มเหลว';}setTimeout(()=>{d.innerText=ogD;d.style.background='#f03';d.style.pointerEvents='auto';},2000);};i.onclick=function(){if(this.src.startsWith('data:'))return;document.getElementById('krt-lb').style.display='flex';document.getElementById('krt-lbi').src=s;sc=1;tx=0;ty=0;up();};c.appendChild(i);c.appendChild(info);c.appendChild(d);gal.appendChild(c);});document.getElementById('krt-close').onclick=function(){sys.remove();};document.getElementById('krt-dl-all').onclick=async function(){var btn=this;if(btn.disabled)return;var imgsToDownload=[];gal.querySelectorAll('img').forEach((imgEl,idx)=>{if(!imgEl.src.startsWith('data:image/svg')){imgsToDownload.push({url:imgEl.getAttribute('data-orig')||imgEl.src,idx:idx});}});if(imgsToDownload.length===0)return alert('ไม่มีรูปที่โหลดได้');var ogTxt=btn.innerText;btn.innerText='PREPARING...';btn.disabled=true;btn.style.background='#555';var pbg=document.getElementById('krt-prog-bg');var pbar=document.getElementById('krt-prog');pbg.style.display='block';pbar.style.width='0%';pbar.innerText='0%';async function doZip(){var zip=new JSZip();var count=0;var processedCount=0;var cIndex=0;async function workerPool(){while(cIndex<imgsToDownload.length){let item=imgsToDownload[cIndex++];let b=await fetchImg(item.url);if(b){var rawFname=item.url.split('/').pop().split('?')[0];try{rawFname=decodeURIComponent(rawFname);}catch(e){}var ext=rawFname.split('.').pop().toLowerCase();if(ext.length>4||ext===rawFname.toLowerCase()||!ext)ext='jpg';var base=rawFname.substring(0,rawFname.lastIndexOf('.'));if(!base)base='KIRITO_IMAGE';let padIdx=String(item.idx+1).padStart(3,'0');zip.file(`${base}_${padIdx}.${ext}`,b);count++;}processedCount++;var pct=Math.round((processedCount/imgsToDownload.length)*100);pbar.style.width=pct+'%';pbar.innerText=processedCount+'/'+imgsToDownload.length+' ('+pct+'%)';btn.innerText='DOWNLOADING...';}}var workers=Array(8).fill(0).map(()=>workerPool());await Promise.all(workers);if(count===0){pbg.style.display='none';btn.innerText='FAILED (โดนบล็อก)';setTimeout(function(){btn.innerText=ogTxt;btn.disabled=false;btn.style.background='#28a745';},4000);return;}pbar.innerText='ZIPPING...';btn.innerText='PACKING ZIP...';try{var content=await zip.generateAsync({type:'blob'});var u2=URL.createObjectURL(content);var a2=document.createElement('a');a2.href=u2;a2.download='KIRITO_PACK_'+Date.now()+'.zip';a2.click();URL.revokeObjectURL(u2);pbg.style.display='none';btn.innerText='SUCCESS! ('+count+'/'+imgsToDownload.length+')';}catch(e){btn.innerText='ZIP ERROR';}setTimeout(function(){btn.innerText=ogTxt;btn.disabled=false;btn.style.background='#28a745';pbg.style.display='none';},4000);}if(typeof JSZip==='undefined'){pbar.innerText='LOADING JSZIP...';var script=document.createElement('script');script.src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';script.onload=doZip;document.head.appendChild(script);}else{doZip();}};var sc=1,tx=0,ty=0,dr=false,sx,sy;function up(){var li=document.getElementById('krt-lbi');if(li)li.style.transform='translate('+tx+'px, '+ty+'px) scale('+sc+')';}var li=document.getElementById('krt-lbi');li.addEventListener('wheel',function(e){e.preventDefault();sc+=e.deltaY*-0.001;sc=Math.min(Math.max(0.5,sc),8);up();},{passive:false});li.addEventListener('mousedown',function(e){e.preventDefault();dr=true;sx=e.clientX-tx;sy=e.clientY-ty;li.style.cursor='grabbing';});sys.addEventListener('mouseup',function(){dr=false;if(li)li.style.cursor='grab';});sys.addEventListener('mousemove',function(e){if(!dr)return;e.preventDefault();tx=e.clientX-sx;ty=e.clientY-sy;up();});
